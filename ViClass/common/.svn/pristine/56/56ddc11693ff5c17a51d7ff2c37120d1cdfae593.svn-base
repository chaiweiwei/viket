//
//  CIALBrowserViewController.m
//  CIALBrowser
//
//  Created by Sylver Bruneau on 01/09/10.
//  Copyright 2011 CodeIsALie. All rights reserved.
//

#import "CIALBrowser.h"
#import "CIALBrowserViewController.h"
#import "UIWebViewAdditions.h"
#import "UnpreventableUILongPressGestureRecognizer.h"
#import "ALDUtils.h"
#import "UIBarButtonItem+ALDBackBarButtonItem.h"

@interface CIALBrowserViewController ()
@property (retain,nonatomic) UIActivityIndicatorView *loadActIndicator;

- (void)addBookmark;
- (void)updateLoadingStatus;
- (void)longPressRecognized:(UILongPressGestureRecognizer *)gestureRecognizer;

- (void)goBack:(id)sender;
- (void)goForward:(id)sender;
- (void)reloadOrStop:(id)sender;
- (void)loadURL:(NSURL *)url;

- (void)dismiss:(id)sender;
@end

@implementation CIALBrowserViewController
@synthesize loadActIndicator=_loadActIndicator;
@synthesize bookmarkPopoverController = _bookmarkPopoverController;
@synthesize addBookmarkPopoverController = _addBookmarkPopoverController;
@synthesize actionActionSheet = _actionActionSheet;
@synthesize modal = _modal;
@synthesize enabledSafari = _enabledSafari;
@synthesize notNeedUrlView=_notNeedUrlView;
@synthesize urlPath=_urlPath;

+ (CIALBrowserViewController *)modalBrowserViewControllerWithURL:(NSURL *)url
{
    CIALBrowserViewController *controller = ALDReturnAutoreleased([[self alloc] initWithURL:url]);
    controller.modal = YES;
    return controller;
}

- (void)dealloc {
    self.urlPath=nil;
    self.bookmarkPopoverController=nil;
    self.addBookmarkPopoverController=nil;
    // Stop the spinner
    [UIApplication sharedApplication].networkActivityIndicatorVisible = NO;
    webView.delegate = nil;
    [webView stopLoading];
    ALDRelease(webView); webView = nil;
    ALDRelease(backButtonItem); backButtonItem = nil;
    ALDRelease(forwardButtonItem); forwardButtonItem = nil;
    ALDRelease(bookmarkButton); bookmarkButton = nil;
    ALDRelease(stopReloadButton); stopReloadButton = nil;
    ALDRelease(locationField); locationField = nil;
    ALDRelease(closeButtonItem); closeButtonItem = nil;
    ALDRelease(navigationBar); navigationBar = nil;
    ALDRelease(_urlToLoad); _urlToLoad = nil;
    ALDRelease(_urlToHandle); _urlToHandle = nil;
    self.loadActIndicator=nil;
    
    self.actionActionSheet = nil;
    ALDRelease(req); req = nil;
#if ! __has_feature(objc_arc)
    [super dealloc];
#endif
}

-(void) viewDidUnload{
    self.bookmarkPopoverController=nil;
    self.addBookmarkPopoverController=nil;
    webView.delegate = nil;
    [webView stopLoading];
    ALDRelease(webView); webView = nil;
    ALDRelease(backButtonItem); backButtonItem = nil;
    ALDRelease(forwardButtonItem); forwardButtonItem = nil;
    ALDRelease(bookmarkButton); bookmarkButton = nil;
    ALDRelease(stopReloadButton); stopReloadButton = nil;
    ALDRelease(locationField); locationField = nil;
    ALDRelease(closeButtonItem);  closeButtonItem = nil;
    ALDRelease(navigationBar); navigationBar = nil;
    ALDRelease(_urlToLoad); _urlToLoad = nil;
    ALDRelease(_urlToHandle); _urlToHandle = nil;
    self.actionActionSheet = nil;
    [super viewDidUnload];
}

- (void)viewWillAppear:(BOOL)animated{
	if (self.hidesBottomBarWhenPushed) {
        [[NSNotificationCenter defaultCenter] postNotificationName:@"hideCustomTabBar" object:nil];
    }
    self.navigationController.navigationBarHidden=NO;
    if (UI_USER_INTERFACE_IDIOM() != UIUserInterfaceIdiomPad) {
        UINavigationBar *navBar=self.navigationController.navigationBar;
        if (locationField) {
            [navBar addSubview:locationField];
        }
    }
    [super viewWillAppear:animated];
}

-(void) viewWillDisappear:(BOOL)animated{
    if (UI_USER_INTERFACE_IDIOM() != UIUserInterfaceIdiomPad) {
        [locationField removeFromSuperview];
    }
    [super viewWillDisappear:animated];
}

- (id)init
{
    self = [super init];
    if (self) {
        self.enabledSafari=YES;
        self.notNeedUrlView=NO;
    }
    return self;
}

- (id)initWithURL:(NSURL *)url  {
    self = [super init];
    if (self) {
        self.enabledSafari=YES;
        self.notNeedUrlView=NO;
        [self setURL:url];
    }
    return self;
}

- (void)loadView {
    UIView *view = [[UIView alloc] initWithFrame:[[UIScreen mainScreen] applicationFrame]];
    self.view=view;
    ALDRelease(view);
    self.view.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight;
    if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad) {
        // Toolbar
        toolBar = [[UIToolbar alloc] initWithFrame:CGRectZero];
        toolBar.barStyle = UIBarStyleDefault;
        [toolBar sizeToFit];
        toolBar.autoresizesSubviews = NO;
        toolBar.frame = CGRectMake(0,
                                   0,
                                   self.view.frame.size.width, 
                                   toolBar.frame.size.height);
        toolBar.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleBottomMargin;
        
        NSMutableArray *buttons = [NSMutableArray arrayWithCapacity:9];
        UIBarButtonItem *flexibleSpaceButtonItem = ALDReturnAutoreleased([[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFlexibleSpace
                                                                                                  target:nil
                                                                                                  action:nil]);
        backButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"CIALBrowser.bundle/images/browserBack.png"]
                                                           style:UIBarButtonItemStylePlain
                                                          target:self
                                                          action:@selector(goBack:)];
        forwardButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"CIALBrowser.bundle/images/browserForward.png"]
                                                              style:UIBarButtonItemStylePlain
                                                             target:self
                                                             action:@selector(goForward:)];
        UIBarButtonItem *bookmarkButtonItem = ALDReturnAutoreleased([[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemBookmarks
                                                                                             target:self
                                                                                             action:@selector(viewBookmark:)]);
        actionButtonItem = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemAction
                                                                          target:self
                                                                          action:@selector(actionButton:)];
        
        locationField = [[UITextField alloc] initWithFrame:CGRectMake(37,7,246,31)];
        locationField.delegate = self;
        locationField.autoresizingMask = UIViewAutoresizingFlexibleWidth;
        locationField.textColor = [UIColor colorWithRed:102.0/255 green:102.0/255 blue:102.0/255 alpha:1.0];
        locationField.textAlignment = TEXT_ALIGN_LEFT;
        locationField.borderStyle = UITextBorderStyleRoundedRect;
        locationField.font = [UIFont fontWithName:@"Helvetica" size:15];
        locationField.autocorrectionType = UITextAutocorrectionTypeNo;
        locationField.contentVerticalAlignment = UIControlContentVerticalAlignmentCenter;
        locationField.clearsOnBeginEditing = NO;
        locationField.autocapitalizationType = UITextAutocapitalizationTypeNone;
        locationField.autocorrectionType = UITextAutocorrectionTypeNo;
        locationField.keyboardType = UIKeyboardTypeURL;
        locationField.returnKeyType = UIReturnKeyGo;        
        locationField.clearButtonMode = UITextFieldViewModeWhileEditing;
        // reloadButton
        stopReloadButton = ALDReturnRetained([UIButton buttonWithType:UIButtonTypeCustom]);
        stopReloadButton.bounds = CGRectMake(0, 0, 26, 30);
        [stopReloadButton setImage:[UIImage imageNamed:@"CIALBrowser.bundle/images/AddressViewReload.png"] forState:UIControlStateNormal];
        [stopReloadButton setImage:[UIImage imageNamed:@"CIALBrowser.bundle/images/AddressViewReload.png"] forState:UIControlStateHighlighted];
        stopReloadButton.showsTouchWhenHighlighted = NO;
        [stopReloadButton addTarget:self action:@selector(reloadOrStop:) forControlEvents:UIControlEventTouchUpInside];
        locationField.rightView = stopReloadButton;
        locationField.rightViewMode = UITextFieldViewModeUnlessEditing;

        UIBarButtonItem *textFieldItem = ALDReturnAutoreleased([[UIBarButtonItem alloc] initWithCustomView:locationField]);

        [buttons addObject:flexibleSpaceButtonItem];
        [buttons addObject:backButtonItem];
        [buttons addObject:flexibleSpaceButtonItem];
        [buttons addObject:forwardButtonItem];
        [buttons addObject:flexibleSpaceButtonItem];
        [buttons addObject:bookmarkButtonItem];
        [buttons addObject:flexibleSpaceButtonItem];
        [buttons addObject:actionButtonItem];
        [buttons addObject:flexibleSpaceButtonItem];
        [buttons addObject:textFieldItem];

        if (self.isModal) {
            NSString *closeTitle = CIALBrowserLocalizedString(@"Close", nil);
            closeButtonItem = [[UIBarButtonItem alloc] initWithTitle:closeTitle style:UIBarButtonItemStyleBordered target:self action:@selector(dismiss:)];
            navigationItem.rightBarButtonItem = closeButtonItem;
            [buttons addObject:closeButtonItem];
        } else {
            [buttons addObject:flexibleSpaceButtonItem];
        }
        
        [toolBar setItems:buttons];
        [self.view addSubview:toolBar];
        
        // webView
        webView = [[UIWebView alloc] initWithFrame:CGRectMake(0, toolBar.frame.size.height , self.view.frame.size.width, self.view.frame.size.height - toolBar.frame.size.height)];
        webView.scalesPageToFit = YES;
        webView.contentMode = UIViewContentModeScaleToFill;
        webView.multipleTouchEnabled = YES;
        webView.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight;
        [self.view addSubview:webView];
    } else {
        navigationItem = [[UINavigationItem alloc] initWithTitle:nil];
        // titleView
        locationField = [[UITextField alloc] initWithFrame:CGRectMake(65,7,246,31)];
        locationField.delegate = self;
        locationField.autoresizingMask = UIViewAutoresizingFlexibleWidth;
        locationField.textColor = [UIColor colorWithRed:102.0/255 green:102.0/255 blue:102.0/255 alpha:1.0];
        locationField.textAlignment = TEXT_ALIGN_LEFT;
        locationField.borderStyle = UITextBorderStyleRoundedRect;
        locationField.font = [UIFont fontWithName:@"Helvetica" size:15];
        locationField.autocorrectionType = UITextAutocorrectionTypeNo;
        locationField.contentVerticalAlignment = UIControlContentVerticalAlignmentCenter;
        locationField.clearsOnBeginEditing = NO;
        
        locationField.autocapitalizationType = UITextAutocapitalizationTypeNone;
        locationField.autocorrectionType = UITextAutocorrectionTypeNo;
        locationField.keyboardType = UIKeyboardTypeURL;
        locationField.returnKeyType = UIReturnKeyGo;
        
        locationField.clearButtonMode = UITextFieldViewModeWhileEditing;
        
        // reloadButton
        stopReloadButton = ALDReturnRetained([UIButton buttonWithType:UIButtonTypeCustom]);
        stopReloadButton.bounds = CGRectMake(0, 0, 26, 30);
        [stopReloadButton setImage:[UIImage imageNamed:@"CIALBrowser.bundle/images/AddressViewReload.png"] forState:UIControlStateNormal];
        [stopReloadButton setImage:[UIImage imageNamed:@"CIALBrowser.bundle/images/AddressViewReload.png"] forState:UIControlStateHighlighted];
        stopReloadButton.showsTouchWhenHighlighted = NO;
        [stopReloadButton addTarget:self action:@selector(reloadOrStop:) forControlEvents:UIControlEventTouchUpInside];
        locationField.rightView = stopReloadButton;
        locationField.rightViewMode = UITextFieldViewModeUnlessEditing;
        
//        navigationItem.titleView = locationField;
        
        if (self.isModal) {
            NSString *closeTitle = CIALBrowserLocalizedString(@"Close", nil);
            closeButtonItem = [[UIBarButtonItem alloc] initWithTitle:closeTitle style:UIBarButtonItemStyleBordered target:self action:@selector(dismiss:)];
            navigationItem.rightBarButtonItem = closeButtonItem;
        }
        
        UINavigationBar *navBar=self.navigationController.navigationBar;
//        [navBar addSubview:locationField];
//        [self.navigationController.navigationBar setItems:[NSArray arrayWithObject:navigationItem]];
//        navigationBar = [[UINavigationBar alloc] initWithFrame:CGRectMake(0, 0, self.view.frame.size.width, 44)];
//        navigationBar.autoresizingMask = UIViewAutoresizingFlexibleWidth;
//        [navigationBar setItems:[NSArray arrayWithObject:navigationItem]];
//        [self.view addSubview:navigationBar];
//        [navigationBar release];
        
        // Toolbar
        toolBar = [[UIToolbar alloc] initWithFrame:CGRectZero];
        toolBar.barStyle = UIBarStyleDefault;
        [toolBar sizeToFit];
        toolBar.autoresizesSubviews = NO;
        toolBar.frame = CGRectMake(0,
                                   self.view.frame.size.height-toolBar.frame.size.height+1,
                                   self.view.frame.size.width, 
                                   toolBar.frame.size.height);
        toolBar.autoresizingMask = UIViewAutoresizingFlexibleHeight | UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleTopMargin;
        toolBar.backgroundColor=navBar.backgroundColor;
        toolBar.tintColor=navBar.tintColor;
        if (isIOS7) {
            toolBar.barTintColor=navBar.backgroundColor;
        }
        
        NSMutableArray *buttons = [NSMutableArray arrayWithCapacity:9];
        UIBarButtonItem *flexibleSpaceButtonItem = ALDReturnAutoreleased([[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemFlexibleSpace
                                                                                                  target:nil
                                                                                                  action:nil]);
        backButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"CIALBrowser.bundle/images/browserBack.png"]
                                                           style:UIBarButtonItemStylePlain
                                                          target:self
                                                          action:@selector(goBack:)];
        forwardButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"CIALBrowser.bundle/images/browserForward.png"]
                                                              style:UIBarButtonItemStylePlain
                                                             target:self
                                                             action:@selector(goForward:)] ;
        actionButtonItem = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemAction
                                                                          target:self
                                                                          action:@selector(actionButton:)] ;
        UIBarButtonItem *bookmarkButtonItem = ALDReturnAutoreleased([[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemBookmarks
                                                                                             target:self
                                                                                             action:@selector(viewBookmark:)]);
        
        [buttons addObject:flexibleSpaceButtonItem];
        [buttons addObject:backButtonItem];
        [buttons addObject:flexibleSpaceButtonItem];
        [buttons addObject:forwardButtonItem];
        [buttons addObject:flexibleSpaceButtonItem];
        [buttons addObject:actionButtonItem];
        [buttons addObject:flexibleSpaceButtonItem];
        [buttons addObject:bookmarkButtonItem];
        [buttons addObject:flexibleSpaceButtonItem];
        
        [toolBar setItems:buttons];
        [self.view addSubview:toolBar];
        
        // webView
        if (navigationBar) {
            webView = [[UIWebView alloc] initWithFrame:CGRectMake(0, navigationBar.frame.size.height , self.view.frame.size.width, self.view.frame.size.height - navigationBar.frame.size.height - toolBar.frame.size.height)];
        }else {
            webView = [[UIWebView alloc] initWithFrame:CGRectMake(0,0, self.view.frame.size.width, self.view.frame.size.height-toolBar.frame.size.height)];
        }
        webView.scalesPageToFit = YES;
        webView.contentMode = UIViewContentModeScaleToFill;
        webView.multipleTouchEnabled = YES;
        webView.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight;
        [self.view addSubview:webView];
        
        if (self.notNeedUrlView) {
            ALDRelease(locationField); locationField=nil;
        }else{
            self.title=nil;
        }
    }
    
    UIActivityIndicatorView *actIndicatorView=[[UIActivityIndicatorView alloc] initWithActivityIndicatorStyle:UIActivityIndicatorViewStyleGray];
    self.loadActIndicator=actIndicatorView;
    [actIndicatorView setCenter:webView.center];
    [actIndicatorView startAnimating];
    actIndicatorView.hidden = YES;
    [webView addSubview:actIndicatorView];
    ALDRelease(actIndicatorView);

    // Create a long press recognizer for handling links long press
    UnpreventableUILongPressGestureRecognizer *longPressRecognizer = [[UnpreventableUILongPressGestureRecognizer alloc] initWithTarget:self action:@selector(longPressRecognized:)];
    longPressRecognizer.allowableMovement = 20;
    longPressRecognizer.minimumPressDuration = 1.0f;
    [webView addGestureRecognizer:longPressRecognizer];
    ALDRelease(longPressRecognizer);
}

- (BOOL)shouldAutorotateToInterfaceOrientation:(UIInterfaceOrientation)interfaceOrientation {
    // On iPad, allow any orientation
    // On iPhone/iPod Touch, allow any orientation but upside down portrait
    BOOL allowRotate = YES;
    if ((UI_USER_INTERFACE_IDIOM() != UIUserInterfaceIdiomPad) && (interfaceOrientation == UIInterfaceOrientationPortraitUpsideDown))  {
        allowRotate = NO;
    }
    if ([_longPressActionSheet isVisible]) {
        allowRotate = NO;
    }
    return allowRotate;
}

- (void)didRotateFromInterfaceOrientation:(UIInterfaceOrientation)fromInterfaceOrientation {
    // The height of the toolbar is changing according to orientation, resize the webview occording to this
    if (UI_USER_INTERFACE_IDIOM() != UIUserInterfaceIdiomPad) {
        if (UIInterfaceOrientationIsPortrait(self.interfaceOrientation)) {
            if (navigationBar) {
                webView.frame = CGRectMake(0, navigationBar.frame.size.height, self.view.frame.size.width, self.view.frame.size.height - navigationBar.frame.size.height - toolBar.frame.size.height);
            }else {
                webView.frame = CGRectMake(0, 0, self.view.frame.size.width, self.view.frame.size.height -toolBar.frame.size.height);
            }
        } else {
            if (navigationBar) {
                webView.frame = CGRectMake(0, navigationBar.frame.size.height, self.view.frame.size.height, self.view.frame.size.width - navigationBar.frame.size.height - toolBar.frame.size.height);
            }else {
                webView.frame = CGRectMake(0, 0, self.view.frame.size.height, self.view.frame.size.width - toolBar.frame.size.height);
            }
        }
    }
}

#pragma mark -

- (void) viewDidLoad {
    [super viewDidLoad];
    
    BOOL isIos7=isIOS7;
    if (self.navigationController /*&& !isIos7*/ && [self.navigationController viewControllers].count>1) {
        UIBarButtonItem *leftBtn=[[UIBarButtonItem alloc] initBackButtonWithTitle:ALDLocalizedString(@"Back", @"关闭") color:kNavigationBarTextColor target:self action:@selector(onBackClicked)];
        self.navigationItem.leftBarButtonItem=leftBtn;
        ALDRelease(leftBtn);
    }
    if (isIos7) {
        self.extendedLayoutIncludesOpaqueBars = NO;
        self.modalPresentationCapturesStatusBarAppearance =NO;
        self.edgesForExtendedLayout = UIRectEdgeNone;
    }
    
    webView.delegate = self;
    
    [self updateLoadingStatus];
    
    if (_urlToLoad) {
        [self loadURL:_urlToLoad];
    } else {
        [locationField becomeFirstResponder];
    }
}

-(void) onBackClicked{
    [self.navigationController popViewControllerAnimated:YES];
}

#pragma mark -

- (void)loadURL:(NSURL *)url {
    if (!webView) {
        [self setURL:url];
        return;
    }
    
    if (!url) return;
    
    locationField.text = url.absoluteString;
    
    [webView loadRequest:[NSURLRequest requestWithURL:url]];
}

-(void) setUrlPath:(NSString *)urlPath{
    if (urlPath==nil) {
        ALDRelease(_urlPath); _urlPath=nil;
        return;
    }
    _urlPath=ALDReturnRetained(urlPath);
    [self loadURL:[NSURL URLWithString:urlPath]];
}

- (void)goBack:(id) sender {
    [webView goBack];
    
    [NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(updateLocationField) object:nil];
    [self performSelector:@selector(updateLocationField) withObject:nil afterDelay:1.];
}

- (void)goForward:(id) sender {
    [webView goForward];
    
    [NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(updateLocationField) object:nil];
    [self performSelector:@selector(updateLocationField) withObject:nil afterDelay:1.];
}

- (void)reloadOrStop:(id) sender {
    if (webView.loading)
        [webView stopLoading];
    else [webView reload];
}

- (NSURL *)url {
    NSURL *url = [NSURL URLWithString:locationField.text];
    if (!url.scheme.length && locationField.text.length) url = [NSURL URLWithString:[@"http://" stringByAppendingString:locationField.text]];
    return url;
}

#pragma mark -
#pragma mark UITextField delegate

- (void)setURL:(NSURL *)url
{
    NSString *urlString = url.absoluteString;
    if ([urlString length]) {
        if (!url.scheme.length) {
            url = [NSURL URLWithString:[@"http://" stringByAppendingString:urlString]];
        }
        ALDRelease(_urlToLoad);
        _urlToLoad = [url copy];
    }
}

- (BOOL) textFieldShouldReturn:(UITextField *) textField {
    NSURL *url = [NSURL URLWithString:locationField.text];
    
    // if user didn't enter "http", add it the the url
    if (!url.scheme.length) {
        url = [NSURL URLWithString:[@"http://" stringByAppendingString:locationField.text]];
    }
    
    [self loadURL:url];
    
    [locationField resignFirstResponder];
    
    return YES;
}

#pragma mark -

- (void) updateLocationField {
    NSString *location = webView.request.URL.absoluteString;
    if (location.length)
        locationField.text = webView.request.URL.absoluteString;
}

#define kActTag 2000
- (void) updateLoadingStatus {
    UIImage *image = nil;
    if (webView.loading) {
        _loadActIndicator.hidden=NO;
        image = [UIImage imageNamed:@"CIALBrowser.bundle/images/AddressViewStop.png"];
        
        [UIApplication sharedApplication].networkActivityIndicatorVisible = YES;
    } else {
        _loadActIndicator.hidden=YES;
        image = [UIImage imageNamed:@"CIALBrowser.bundle/images/AddressViewReload.png"];
        
        [UIApplication sharedApplication].networkActivityIndicatorVisible = NO;
    }
    
    [stopReloadButton setImage:image forState:UIControlStateNormal];
    
    // update status of back/forward buttons
    backButtonItem.enabled = [webView canGoBack];
    forwardButtonItem.enabled = [webView canGoForward];
}

#pragma mark -
#pragma mark UIWebView delegate

- (BOOL)webView:(UIWebView *) sender shouldStartLoadWithRequest:(NSURLRequest *) request navigationType:(UIWebViewNavigationType) navigationType {
    if ([request.URL.absoluteString isEqual:@"about:blank"])
        return NO;
//    [req release];
//    req = (NSMutableURLRequest *)[request retain];
//    NSLog(@"request path:%@",request.URL.absoluteString);
    return YES;
}

- (void) webViewDidStartLoad:(UIWebView *) sender {
    [self updateLoadingStatus];
}

- (void) webViewDidFinishLoad:(UIWebView *) sender {
    // Disable the defaut actionSheet when doing a long press
    [webView stringByEvaluatingJavaScriptFromString:@"document.body.style.webkitTouchCallout='none';"];
    [webView stringByEvaluatingJavaScriptFromString:@"document.documentElement.style.webkitTouchCallout='none';"];
    if (self.notNeedUrlView) {
        self.title =[webView stringByEvaluatingJavaScriptFromString:@"document.title"];
    }
    [NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(updateLocationField) object:nil];
    [self performSelector:@selector(updateLocationField) withObject:nil afterDelay:1.];
    
    [NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(updateLoadingStatus) object:nil];
    [self performSelector:@selector(updateLoadingStatus) withObject:nil afterDelay:1.];
}

- (void) webView:(UIWebView *)sender didFailLoadWithError:(NSError *) error {
    switch ([error code]) {
        case kCFURLErrorCancelled :
        {
            // Do nothing in this case
            break;
        }
        default:
        {
            UIAlertView *alert = [[UIAlertView alloc] initWithTitle:CIALBrowserLocalizedString(@"Error",@"") 
                                                            message:[error localizedDescription]
                                                           delegate:nil
                                                  cancelButtonTitle:CIALBrowserLocalizedString(@"OK",@"")
                                                  otherButtonTitles:nil];
            [alert show];    
            ALDRelease(alert);
            break;
        }
    }
    
    [NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(updateLocationField) object:nil];
    [self performSelector:@selector(updateLocationField) withObject:nil afterDelay:1.];
    
    [NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(updateLoadingStatus) object:nil];
    [self performSelector:@selector(updateLoadingStatus) withObject:nil afterDelay:1.];
}

#pragma mark actions -

- (void)dismiss:(id)sender
{
    [self dismissViewControllerAnimated:YES completion:^{
        //
    }];
}


#pragma mark -
#pragma mark UIBarButtonItem functions

- (void)viewBookmark:(UIBarButtonItem *)button {
    // Make other popover disappear
    if ([self.actionActionSheet isVisible]) {
        [self.actionActionSheet dismissWithClickedButtonIndex:self.actionActionSheet.cancelButtonIndex
                                                     animated:YES];
    }
    
    if ([self.addBookmarkPopoverController isPopoverVisible]) {
        [self.addBookmarkPopoverController dismissPopoverAnimated:YES];
    }

    if (printInteraction != nil) {
        [printInteraction dismissAnimated:YES];
        printInteraction = nil;
    }

    // Create the popover or make it disappear if needed
    if (self.bookmarkPopoverController.popoverVisible) {
        [self.bookmarkPopoverController dismissPopoverAnimated:YES];
        self.bookmarkPopoverController = nil;
    } else {
        ViewBookmarkViewController * viewBookmarkViewController = ALDReturnAutoreleased([[ViewBookmarkViewController alloc] initWithStyle:UITableViewStyleGrouped]);
        viewBookmarkViewController.delegate = self;
        [viewBookmarkViewController setBookmark:[webView stringByEvaluatingJavaScriptFromString:@"document.title"]
                                        url:self.url];
        UINavigationController *navController = ALDReturnAutoreleased([[UINavigationController alloc] initWithRootViewController:viewBookmarkViewController]);
        
        navController.modalTransitionStyle = UIModalTransitionStyleCoverVertical;
        
        if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad) {
            self.bookmarkPopoverController = ALDReturnAutoreleased([[UIPopoverController alloc] initWithContentViewController:navController]);
            [self.bookmarkPopoverController presentPopoverFromBarButtonItem:button
                                                   permittedArrowDirections:UIPopoverArrowDirectionDown|UIPopoverArrowDirectionUp
                                                                   animated:YES];
        } else {
            [self presentViewController:navController animated:YES completion:^{
                //
            }];
        }
    }

}

- (void)addBookmark {
    AddBookmarkViewController * addBookmarkViewController = ALDReturnAutoreleased([[AddBookmarkViewController alloc] initWithStyle:UITableViewStyleGrouped]);
    [addBookmarkViewController setBookmark:[webView stringByEvaluatingJavaScriptFromString:@"document.title"]
                                       url:self.url];
    addBookmarkViewController.delegate = self;
    UINavigationController *navController = ALDReturnAutoreleased([[UINavigationController alloc] initWithRootViewController:addBookmarkViewController]);
    
    navController.modalTransitionStyle = UIModalTransitionStyleCoverVertical;
    
    if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad) {
        self.addBookmarkPopoverController = ALDReturnAutoreleased([[UIPopoverController alloc] initWithContentViewController:navController]);
        self.addBookmarkPopoverController.popoverContentSize = CGSizeMake(320.0, 150.0);
        [self.addBookmarkPopoverController presentPopoverFromBarButtonItem:actionButtonItem
                                               permittedArrowDirections:UIPopoverArrowDirectionDown|UIPopoverArrowDirectionUp
                                                               animated:YES];
    } else {
        [self presentViewController:navController animated:YES completion:^{
            //
        }];
    }
}

- (void)actionButton:(UIBarButtonItem *)button {
    if ([self.bookmarkPopoverController isPopoverVisible]) {
        [self.bookmarkPopoverController dismissPopoverAnimated:YES];
    }
    if ([self.addBookmarkPopoverController isPopoverVisible]) {
        [self.addBookmarkPopoverController dismissPopoverAnimated:YES];
        // addBookmarkPopoverController is created by this actionSheet
        // if this button is tapped, make the popover disappear and don't create the actionSheet
        return;
    }
    
    if (printInteraction != nil) {
        [printInteraction dismissAnimated:YES];
        printInteraction = nil;
        // printInteraction is created by this actionSheet
        // if this button is tapped, make it disappear and don't create the actionSheet
        return;
    }
    
    // Create the actionSheet or make it disappear if needed
    if (!self.actionActionSheet) {
        UIActionSheet *sheet= [[UIActionSheet alloc] initWithTitle:[_urlToHandle.absoluteString stringByReplacingPercentEscapesUsingEncoding:NSUTF8StringEncoding]
                                                         delegate:self
                                                cancelButtonTitle:nil
                                           destructiveButtonTitle:nil
                                                otherButtonTitles:nil];
        self.actionActionSheet=sheet;
        ALDRelease(sheet);
        self.actionActionSheet.actionSheetStyle = UIActionSheetStyleDefault;
        
        copyButtonIndex = -1;
        openLinkButtonIndex = -1;
        addBookmarkButtonIndex = [self.actionActionSheet addButtonWithTitle:CIALBrowserLocalizedString(@"Add bookmark",nil)];
        
        if (self.enabledSafari) {
            openWithSafariButtonIndex = [self.actionActionSheet addButtonWithTitle:CIALBrowserLocalizedString(@"Open with Safari",@"")];
        } else {
            openWithSafariButtonIndex = -1;
        }
        
        if ([MFMailComposeViewController canSendMail]) {
            sendUrlButtonIndex = [self.actionActionSheet addButtonWithTitle:CIALBrowserLocalizedString(@"Mail Link to this Page",@"")];
        }
        
        Class printInteractionController = NSClassFromString(@"UIPrintInteractionController");
        if ((printInteractionController != nil) && [printInteractionController isPrintingAvailable]) {
            printButtonIndex = [self.actionActionSheet addButtonWithTitle:CIALBrowserLocalizedString(@"Print",@"")];
        } else {
            printButtonIndex = -1;
        }
        
        if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad) {
            self.actionActionSheet.cancelButtonIndex = -1;
        } else {
            self.actionActionSheet.cancelButtonIndex = [_actionActionSheet addButtonWithTitle:CIALBrowserLocalizedString(@"Cancel",@"")];
        }
    }
    if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad) {
        if (_actionActionSheet.visible) {
            [_actionActionSheet dismissWithClickedButtonIndex:_actionActionSheet.cancelButtonIndex
                                                     animated:YES];
        } else {
            [_actionActionSheet showFromBarButtonItem:button animated:YES];
        }
    } else {
        if (self.tabBarController) {
            [_actionActionSheet showInView:self.tabBarController.view];
        }else{
            [_actionActionSheet showInView:self.view];
        }
    }
}

#pragma mark -
#pragma mark UIActionSheet delegate

- (void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex {
    if (copyButtonIndex == buttonIndex) {
        NSString *urlString;
        if (req != nil) {
            urlString = [req.URL.absoluteString stringByReplacingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
        } else {
            urlString = [_urlToHandle.absoluteString  stringByReplacingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
        }
        
        UIPasteboard *pasteBoard = [UIPasteboard generalPasteboard];
        
        [pasteBoard setValue:urlString forPasteboardType:@"public.utf8-plain-text"];
    } else if (openLinkButtonIndex == buttonIndex) {
        [self loadURL:_urlToHandle];
        ALDRelease(_urlToHandle); _urlToHandle = nil;
    } else if (addBookmarkButtonIndex == buttonIndex) {
        [self addBookmark];
    } else if (openWithSafariButtonIndex == buttonIndex) {
        [[UIApplication sharedApplication] openURL:self.url];
    } else if (sendUrlButtonIndex == buttonIndex) {
        MFMailComposeViewController *mailViewController = [[MFMailComposeViewController alloc] init];
        [mailViewController setSubject:[webView stringByEvaluatingJavaScriptFromString:@"document.title"]];
        [mailViewController setMessageBody:[self.url absoluteString]
                                    isHTML:NO];
        
        mailViewController.mailComposeDelegate = self;
        
        if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad) {
            mailViewController.modalPresentationStyle = UIModalPresentationPageSheet;
        }
        [self presentViewController:mailViewController animated:YES completion:^{
            //
        }];
        ALDRelease(mailViewController);
    } else if (printButtonIndex == buttonIndex) {
        Class printInteractionController = NSClassFromString(@"UIPrintInteractionController");
        
        if ((printInteractionController != nil) && [printInteractionController isPrintingAvailable])
        {
            printInteraction = [printInteractionController sharedPrintController];
            printInteraction.delegate = self;
            
            UIPrintInfo *printInfo = [NSClassFromString(@"UIPrintInfo") printInfo];
            
            printInfo.duplex = UIPrintInfoDuplexLongEdge;
            printInfo.outputType = UIPrintInfoOutputGeneral;
            printInfo.jobName = [webView stringByEvaluatingJavaScriptFromString:@"document.title"];
            
            printInteraction.printInfo = printInfo;
            printInteraction.showsPageRange = YES;
            
            UIViewPrintFormatter *formatter = [webView viewPrintFormatter];
            printInteraction.printFormatter = formatter;
            
            [printInteraction presentFromBarButtonItem:actionButtonItem
                                              animated:YES
                                     completionHandler:
             ^(UIPrintInteractionController *pic, BOOL completed, NSError *error) {
             }
             ];
        }
    }
    
    if (req != nil) {
        ALDRelease(req);
        req = nil;
    }    
}

- (void)actionSheet:(UIActionSheet *)actionSheet didDismissWithButtonIndex:(NSInteger)buttonIndex
{
    if (actionSheet == _longPressActionSheet)
    {
        _longPressActionSheet = nil;
    }
}

#pragma mark -
#pragma mark MFMailComposeViewController delegates

- (void)mailComposeController:(MFMailComposeViewController*)controller
          didFinishWithResult:(MFMailComposeResult)result
                        error:(NSError*)error {
    [self dismissViewControllerAnimated:YES completion:^{
        //
    }];
    
    NSString *mailError = nil;
    
    switch (result) {
        case MFMailComposeResultSent:
            break;
        case MFMailComposeResultFailed:
            mailError = CIALBrowserLocalizedString(@"Failed sending email, please try again...",@"");
            break;
        default:
            break;
    }
    
    if (mailError != nil) {
        UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@""
                                                        message:mailError
                                                       delegate:nil
                                              cancelButtonTitle:@"OK"
                                              otherButtonTitles:nil];
        [alert show];
        ALDRelease(alert);
    }
}

#pragma mark -
#pragma mark UIPrintInteractionControllerDelegate
- (void)printInteractionControllerDidDismissPrinterOptions:(UIPrintInteractionController *)printInteractionController {
    NSLog(@"printInteractionControllerDidDismissPrinterOptions");
    printInteraction = nil;
}

#pragma mark -
#pragma mark UILongPressGestureRecognizer handling

- (void)longPressRecognized:(UILongPressGestureRecognizer *)gestureRecognizer {
    if (gestureRecognizer.state == UIGestureRecognizerStateBegan) {
        CGPoint point = [gestureRecognizer locationInView:webView];
        
        // convert point from view to HTML coordinate system
        CGSize viewSize = [webView frame].size;
        CGSize windowSize = [webView windowSize];
        
        CGFloat f = windowSize.width / viewSize.width;
        if ([[[UIDevice currentDevice] systemVersion] doubleValue] >= 5.) {
            point.x = point.x * f;
            point.y = point.y * f;
        } else {
            // On iOS 4 and previous, document.elementFromPoint is not taking
            // offset into account, we have to handle it
            CGPoint offset = [webView scrollOffset];
            point.x = point.x * f + offset.x;
            point.y = point.y * f + offset.y;
        }
                
        // Load the JavaScript code from the Resources and inject it into the web page
        NSBundle *bundle = [NSBundle bundleWithPath:[[NSBundle mainBundle] pathForResource:@"CIALBrowser" ofType:@"bundle"]];

        NSString *path = [bundle pathForResource:@"JSTools" ofType:@"js"];
        NSString *jsCode = [NSString stringWithContentsOfFile:path encoding:NSUTF8StringEncoding error:nil];
        [webView stringByEvaluatingJavaScriptFromString: jsCode];
        
        // get the Tags at the touch location
        NSString *tags = [webView stringByEvaluatingJavaScriptFromString:
                          [NSString stringWithFormat:@"MyAppGetHTMLElementsAtPoint(%i,%i);",(NSInteger)point.x,(NSInteger)point.y]];
        
        NSString *tagsHREF = [webView stringByEvaluatingJavaScriptFromString:
                              [NSString stringWithFormat:@"MyAppGetLinkHREFAtPoint(%i,%i);",(NSInteger)point.x,(NSInteger)point.y]];
        
        NSString *tagsSRC = [webView stringByEvaluatingJavaScriptFromString:
                             [NSString stringWithFormat:@"MyAppGetLinkSRCAtPoint(%i,%i);",(NSInteger)point.x,(NSInteger)point.y]];
        
        NSString *url = nil;
        if ([tags rangeOfString:@",IMG,"].location != NSNotFound) {
            url = tagsSRC;
        }
        if ([tags rangeOfString:@",A,"].location != NSNotFound) {
            url = tagsHREF;
        }
        
//        NSArray *urlArray = [[url lowercaseString] componentsSeparatedByString:@"/"];
//        NSString *urlBase = nil;
//        if ([urlArray count] > 2) {
//            urlBase = [urlArray objectAtIndex:2];
//        }
        
        if ((url != nil) &&
            ([url length] != 0)) {
            // Release any previous request
            ALDRelease(req); req = nil;
            // Save URL for the request
            ALDRelease(_urlToHandle); _urlToHandle = nil;
            _urlToHandle = [[NSURL alloc] initWithString:url];
            
            // ask user what to do
            _longPressActionSheet = [[UIActionSheet alloc] initWithTitle:[_urlToHandle.absoluteString stringByReplacingPercentEscapesUsingEncoding:NSUTF8StringEncoding]
                                                                delegate:self
                                                       cancelButtonTitle:nil
                                                  destructiveButtonTitle:nil
                                                       otherButtonTitles:nil];
            _longPressActionSheet.actionSheetStyle = UIActionSheetStyleDefault;
            
            openLinkButtonIndex = [_longPressActionSheet addButtonWithTitle:CIALBrowserLocalizedString(@"Open",@"")];
            copyButtonIndex = [_longPressActionSheet addButtonWithTitle:CIALBrowserLocalizedString(@"Copy",@"")];
            
            if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad) {
                CGPoint touchPosition = [gestureRecognizer locationInView:webView];
                [_longPressActionSheet showFromRect:CGRectMake(touchPosition.x, touchPosition.y, 1, 1)
                                             inView:webView
                                           animated:YES];
            } else {
                _longPressActionSheet.cancelButtonIndex = [_longPressActionSheet addButtonWithTitle:CIALBrowserLocalizedString(@"Cancel",@"")];
                if (self.tabBarController) {
                    [_longPressActionSheet showInView:self.tabBarController.view];
                }else{
                    [_longPressActionSheet showInView:self.view];
                }
            }
            ALDRelease(_longPressActionSheet);
        }        
    }
}

#pragma mark -
#pragma mark Bookmark delegates

- (void)openThisURL:(NSURL *)url {
    [self loadURL:url];
}

- (void)dismissViewBookmMarkViewController:(ViewBookmarkViewController *)viewController {
    if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad) {
        [self.bookmarkPopoverController dismissPopoverAnimated:YES];
    } else {
        [viewController dismissViewControllerAnimated:YES completion:^{
           //
        }];
    }
}

#pragma mark -
#pragma mark addBookmark delegates

- (void)dismissAddBookmMarkViewController:(AddBookmarkViewController *)viewController {
    if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPad) {
        [self.addBookmarkPopoverController dismissPopoverAnimated:YES];
    } else {
        [viewController dismissViewControllerAnimated:YES completion:^{
            //
        }];
    }
}

@end
